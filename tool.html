<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>グラブル ムーブ表作成ツール</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

    <div class="container">
        <h1>グラブル ムーブ表作成ツール</h1>

        <div id="setup-phase">
            <h2>1. 編成登録 / 保存ロード</h2>

            <fieldset id="save-load-section">
                <legend>保存 / ロード (スロット)</legend>
                <div>
                    <label for="save-slot-name">スロット名</label>
                    <input type="text" id="save-slot-name">
                </div>
                <div>
                    <label for="load-slot-select">保存済みスロット</label>
                    <select id="load-slot-select">
                        <option value="">-- スロットを選択 --</option>
                    </select>
                </div>
                <button id="save-btn" class="btn">現在の編成/ムーブを保存</button>
                <div style="display: flex; gap: 5px;">
                    <button id="load-btn" class="btn" style="flex: 1;">ロード</button>
                    <button id="delete-btn" class="btn" style="flex: 1;">削除</button>
                </div>

                <legend style="margin-top: 15px; grid-column: 1 / -1; text-align: center;">ファイル共有 (バックアップ)</legend>
                <button id="export-btn" class="btn">現在のデータをファイルへ保存 (Export)</button>

                <input type="file" id="import-file-input" accept=".json, text/plain">
                <label for="import-file-input" class="btn import-btn-label">ファイルから読込 (Import)</label>
            </fieldset>

            <fieldset>
                <legend>ムーブ全体メモ</legend>
                <textarea id="overall-memo-input" placeholder="ムーブの前提条件、討伐時間目安、注意点など..."></textarea>
            </fieldset>

            <fieldset>
                <legend>武器編成スクリーンショット (1枚)</legend>
                <input type="file" id="weapon-image-input" accept="image/*" style="display: none;">
                <div id="weapon-image-upload-area" onclick="document.getElementById('weapon-image-input').click();">
                    クリックして画像を選択 (またはドラッグ＆ドロップ)<br>
                    <span style="font-weight: bold; color: #ffb400;">またはペースト (Ctrl+V)</span><br>
                    <span id="upload-feedback">(推奨: 500KB以下 / 自動リサイズあり)</span>
                    <img id="weapon-image-preview" src="#" alt="武器編成プレビュー">
                </div>
                <button id="clear-weapon-image-btn" class="btn">画像を削除</button>
            </fieldset>

            <fieldset>
                <legend>キャラクター</legend>
                <div class="input-grid">
                    <div>
                        <label>サブ人数</label>
                        <select id="sub-member-count">
                            <option value="2" selected>2人 (デフォルト)</option>
                            <option value="5">5人 (その他)</option>
                        </select>
                    </div>
                </div>
                <div class="input-grid" style="margin-top: 10px;">
                    <div><label for="char1">主人公</label><input type="text" id="char1" value="主人公"></div>
                    <div><label for="char2">キャラ2</label><input type="text" id="char2" value=""></div>
                    <div><label for="char3">キャラ3</label><input type="text" id="char3" value=""></div>
                    <div><label for="char4">キャラ4</label><input type="text" id="char4" value=""></div>
                    <div><label for="char5">サブ1</label><input type="text" id="char5" value=""></div>
                    <div><label for="char6">サブ2</label><input type="text" id="char6" value=""></div>

                    <div id="extra-sub-inputs">
                        <div><label for="char7">サブ3</label><input type="text" id="char7" value=""></div>
                        <div><label for="char8">サブ4</label><input type="text" id="char8" value=""></div>
                        <div><label for="char9">サブ5</label><input type="text" id="char9" value=""></div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>召喚石</legend>
                <div class="input-grid">
                    <div><label for="summon-main">メイン</label><input type="text" id="summon-main" value=""></div>
                    <div><label for="summon-support">サポーター</label><input type="text" id="summon-support" value=""></div>
                    <div><label for="summon-sub1">サブ1</label><input type="text" id="summon-sub1" value="バブ"></div>
                    <div><label for="summon-sub2">サブ2</label><input type="text" id="summon-sub2" value="黒麒麟"></div>
                    <div><label for="summon-sub3">サブ3</label><input type="text" id="summon-sub3" value="ヤチマ"></div>
                    <div><label for="summon-sub4">サブ4</label><input type="text" id="summon-sub4" value=""></div>
                </div>
            </fieldset>

            <button id="setup-complete-btn" class="btn">ムーブ入力画面へ</button>

            <div class="reset-buttons" style="margin-top: 15px;">
                <button id="reset-setup-btn" class="reset-btn btn">編成入力欄のみクリア</button>
                <button id="clear-all-data-btn" class="btn">全スロット削除 (完全リセット)</button>
            </div>
        </div>

        <div id="move-phase">
            <h2>2. ムーブ入力</h2>

            <div class="move-grid">
                <div class="action-panel">
                    <div id="turn-counter">TURN 1</div>

                    <div>
                        <strong>このターンのメモ:</strong>
                        <textarea id="turn-memo-input" placeholder="HP予兆、敵の行動など..."></textarea>
                    </div>

                    <div>
                        <strong>行動キャラ選択:</strong>
                        <div class="char-select-buttons" id="char-select-container"></div>
                    </div>

                    <div>
                        <strong>アビリティ:</strong>
                        <div class="action-buttons">
                            <button class="action-btn btn" data-action="1アビ">1アビ</button>
                            <button class="action-btn btn" data-action="2アビ">2アビ</button>
                            <button class="action-btn btn" data-action="3アビ">3アビ</button>
                            <button class="action-btn btn" data-action="4アビ">4アビ</button>
                        </div>
                    </div>

                    <div>
                        <strong>その他 (キャラ別):</strong>
                        <div class="action-buttons">
                            <button class="action-btn btn" data-action="ガード">ガード</button>
                            <button class="action-btn btn attack-btn-on" data-action="キュアポ">キュアポ</button>
                        </div>
                    </div>

                    <div>
                        <strong>召喚石 (全体):</strong>
                        <div class="summon-buttons" id="summon-buttons-container"></div>
                    </div>

                    <div>
                        <strong>アイテム (全体):</strong>
                        <div class="action-buttons">
                            <button class="action-btn btn attack-btn-on" data-action="オールポーション">オールポーション</button>
                        </div>
                    </div>

                    <div>
                        <strong>ターン終了:</strong>
                        <div class="action-buttons">
                            <button class="action-btn attack-btn-off btn" data-action="攻撃 (奥義OFF)">攻撃 (奥義OFF)</button>
                            <button class="action-btn attack-btn-on btn" data-action="攻撃 (奥義ON)">攻撃 (奥義ON)</button>
                        </div>
                    </div>

                    <div class="reset-buttons">
                        <button id="overwrite-save-btn" class="btn" style="background-color: #4CAF50;">現在のスロットに上書き保存</button>
                        <button id="undo-last-action-btn" class="reset-btn btn" style="background-color: #ff9800;">1つ前の操作に戻る (Undo)</button>
                        <button id="move-reset-btn" class="reset-btn btn">ムーブ履歴だけリセット</button>
                        <button id="back-to-setup-btn" class="reset-btn btn">編成登録/ロード画面に戻る</button>
                    </div>
                </div>

                <div>
                    <div id="mode-toggle-area">
                        <button id="goto-playback-btn" class="btn">再生モードへ ▶</button>
                    </div>

                    <div class="history-panel">
                        <strong>行動履歴 (ムーブ表)</strong>
                        <textarea id="move-history" readonly></textarea>

                        <div id="export-area">
                            <span id="copy-feedback"></span>
                            <button id="copy-history-btn" class="btn">ムーブ履歴をコピー</button>
                        </div>
                    </div>

                    <div class="playback-panel">
                        <strong>再生モード (カンペ)</strong>
                        <div id="playback-area">
                        </div>
                        <div id="playback-nav">
                            <button id="playback-prev-btn" class="btn">&lt; 前のターン</button>
                            <span id="playback-nav-center">TURN 1 / 1</span>
                            <button id="playback-next-btn" class="btn">次のターン &gt;</button>
                        </div>
                        <div style="margin-top: 10px; text-align: center;">
                             <button id="save-playback-image-btn" class="btn">ムーブ表を画像で保存</button>
                             <button id="back-to-edit-btn" class="reset-btn btn" style="margin-top: 5px;">編集モードに戻る</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- ローカルストレージキー ---
        const STORAGE_KEY_SLOTS = 'gbfMoveMakerV5_slots';
        const STORAGE_KEY_PREFIX = 'gbfMoveMakerV5_slot_';
        const STORAGE_KEY_CURRENT = 'gbfMoveMakerV5_currentWork';

        // --- 画像リサイズ設定 ---
        const MAX_IMAGE_WIDTH = 1200;
        const IMAGE_QUALITY = 0.7;

        // --- データ構造の定義 ---
        const getDefaultWorkData = () => ({
            setup: {
                characters: ["主人公", "", "", "", "", "", "", "", ""],
                summons: ["", "", "バブ", "黒麒麟", "ヤチマ", ""],
                subCount: 2,
                overallMemo: "",
                weaponImageBase64: null
            },
            state: {
                currentTurn: 1,
                history: "--- TURN 1 ---",
                selectedCharIndex: 0,
                turnMemos: {}
            },
            slotName: ""
        });

        // --- グローバル変数 ---
        let currentWorkData = getDefaultWorkData();
        let savedSlotNames = [];
        let currentPlaybackTurn = 1;
        let totalPlaybackTurns = 1;

        // --- DOM要素の取得 ---
        const setupPhase = document.getElementById('setup-phase');
        const movePhase = document.getElementById('move-phase');
        const setupCompleteBtn = document.getElementById('setup-complete-btn');
        const charInputs = Array.from({length: 9}, (_, i) => document.getElementById(`char${i + 1}`));
        const summonInputs = [ /* ... V12と同じ ... */ ];
        const subMemberCountSelect = document.getElementById('sub-member-count');
        const extraSubInputs = document.getElementById('extra-sub-inputs');
        const saveSlotNameInput = document.getElementById('save-slot-name');
        const loadSlotSelect = document.getElementById('load-slot-select');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const clearAllDataBtn = document.getElementById('clear-all-data-btn');
        const exportBtn = document.getElementById('export-btn');
        const importFileInput = document.getElementById('import-file-input');
        const resetSetupBtn = document.getElementById('reset-setup-btn');
        const overwriteSaveBtn = document.getElementById('overwrite-save-btn');
        const undoLastActionBtn = document.getElementById('undo-last-action-btn');
        const overallMemoInput = document.getElementById('overall-memo-input');
        const weaponImageInput = document.getElementById('weapon-image-input');
        const weaponImageUploadArea = document.getElementById('weapon-image-upload-area');
        const weaponImagePreview = document.getElementById('weapon-image-preview');
        const clearWeaponImageBtn = document.getElementById('clear-weapon-image-btn');
        const uploadFeedback = document.getElementById('upload-feedback');
        const turnCounter = document.getElementById('turn-counter');
        const turnMemoInput = document.getElementById('turn-memo-input');
        const charSelectContainer = document.getElementById('char-select-container');
        const actionButtons = document.querySelectorAll('.action-btn');
        const summonButtonsContainer = document.getElementById('summon-buttons-container');
        const historyTextarea = document.getElementById('move-history');
        const moveResetBtn = document.getElementById('move-reset-btn');
        const backToSetupBtn = document.getElementById('back-to-setup-btn');
        const copyHistoryBtn = document.getElementById('copy-history-btn');
        const copyFeedback = document.getElementById('copy-feedback');
        const gotoPlaybackBtn = document.getElementById('goto-playback-btn');
        const playbackArea = document.getElementById('playback-area');
        const playbackPrevBtn = document.getElementById('playback-prev-btn');
        const playbackNextBtn = document.getElementById('playback-next-btn');
        const playbackNavCenter = document.getElementById('playback-nav-center');
        const backToEditBtn = document.getElementById('back-to-edit-btn');
        const savePlaybackImageBtn = document.getElementById('save-playback-image-btn');

        // --- データ保存/ロード関数 (V12と同じ) ---
        function saveCurrentWork() { /* ... V12と同じ ... */ }
        function loadCurrentWork() { /* ... V12と同じ ... */ }
        function loadSlotNames() { /* ... V12と同じ ... */ }
        function saveSlotNames() { /* ... V12と同じ ... */ }
        function loadSetupDataToDOM() { /* ... V12と同じ ... */ }
        function loadStateDataToDOM() { /* ... V12と同じ ... */ }
        function toggleExtraSubInputs(count) { /* ... V12と同じ ... */ }

        // --- イベントリスナー ---
        setupCompleteBtn.addEventListener('click', () => { saveCurrentWork(); goToMovePhase(); });
        charInputs.forEach(input => input.addEventListener('input', saveCurrentWork));
        summonInputs.forEach(input => input.addEventListener('input', saveCurrentWork));
        subMemberCountSelect.addEventListener('change', (e) => { toggleExtraSubInputs(parseInt(e.target.value, 10)); saveCurrentWork(); });
        turnMemoInput.addEventListener('input', () => { currentWorkData.state.turnMemos[currentWorkData.state.currentTurn] = turnMemoInput.value; saveCurrentWork(); });
        saveBtn.addEventListener('click', () => { /* ... V14と同じ ... */ });
        loadBtn.addEventListener('click', () => { /* ... V14と同じ ... */ });
        deleteBtn.addEventListener('click', () => { /* ... V14と同じ ... */ });
        actionButtons.forEach(btn => { /* ... V14と同じ ... */ });
        moveResetBtn.addEventListener('click', () => { /* ... V14と同じ ... */ });
        backToSetupBtn.addEventListener('click', () => { saveCurrentWork(); goToSetupPhase(); });
        clearAllDataBtn.addEventListener('click', () => { /* ... V14と同じ ... */ });
        copyHistoryBtn.addEventListener('click', () => { /* ... V14と同じ ... */ });
        exportBtn.addEventListener('click', () => { /* ... V11と同じ ... */ });
        importFileInput.addEventListener('change', (event) => { /* ... V11と同じ ... */ });
        resetSetupBtn.addEventListener('click', () => { /* ... V14と同じ ... */ });
        overwriteSaveBtn.addEventListener('click', () => { /* ... V14と同じ ... */ });
        undoLastActionBtn.addEventListener('click', () => { /* ... V16と同じ ... */ });
        overallMemoInput.addEventListener('input', saveCurrentWork);
        weaponImageInput.addEventListener('change', handleImageUpload);
        clearWeaponImageBtn.addEventListener('click', () => { /* ... V12と同じ ... */ });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { weaponImageUploadArea.addEventListener(eventName, preventDefaults, false); });
        ['dragenter', 'dragover'].forEach(eventName => { weaponImageUploadArea.addEventListener(eventName, () => weaponImageUploadArea.classList.add('highlight'), false); });
        ['dragleave', 'drop'].forEach(eventName => { weaponImageUploadArea.addEventListener(eventName, () => weaponImageUploadArea.classList.remove('highlight'), false); });
        weaponImageUploadArea.addEventListener('drop', handleImageDrop, false);
        gotoPlaybackBtn.addEventListener('click', () => { saveCurrentWork(); movePhase.classList.add('playback-mode'); buildPlaybackView(); });
        backToEditBtn.addEventListener('click', () => { movePhase.classList.remove('playback-mode'); loadStateDataToDOM(); });
        playbackNextBtn.addEventListener('click', () => { /* ... V15と同じ ... */ });
        playbackPrevBtn.addEventListener('click', () => { /* ... V15と同じ ... */ });
        savePlaybackImageBtn.addEventListener('click', async () => { /* ... V13と同じ ... */ });

        // ★V17: ペーストイベントリスナーを追加
        document.addEventListener('paste', handlePaste);

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function handleImageDrop(e) { /* ... V12と同じ ... */ }
        function handleImageUpload(event) { /* ... V12と同じ ... */ }

        // ★V17: ペースト処理関数
        function handlePaste(event) {
            // ペーストイベントがテキストエリア内で発生した場合は無視
            if (event.target === turnMemoInput || event.target === overallMemoInput || event.target.tagName === 'INPUT') {
                return;
            }

            const items = event.clipboardData?.items;
            if (!items) return;

            for (let i = 0; i < items.length; i++) {
                // 画像データのみを処理
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    if (blob) {
                        // デフォルトのペースト動作（例えばテキストとして貼り付けられる）をキャンセル
                        event.preventDefault();

                        // ファイル名を生成（例: pasted_image.png）
                        const fileName = `pasted_image.${blob.type.split('/')[1] || 'png'}`;
                        const file = new File([blob], fileName, { type: blob.type });

                        // 既存の画像処理関数に渡す
                        handleImageFile(file);
                        
                        // 最初の画像だけ処理してループを抜ける
                        break;
                    }
                }
            }
        }


        // --- 画像処理・プレビュー更新関数 (V12と同じ) ---
        function handleImageFile(file) { /* ... V12と同じ ... */ }
        function updateImagePreview(base64String) { /* ... V12と同じ ... */ }

        // --- 内部関数 (変更なし) ---
        function logToHistory(text) { /* ... V16と同じ ... */ }
        function selectCharacter(index) { /* ... V16と同じ ... */ }
        function goToMovePhase() { /* ... V16と同じ ... */ }
        function goToSetupPhase() { /* ... V16と同じ ... */ }
        function buildPlaybackView() { /* ... V15と同じ ... */ }
        function updatePlaybackHighlight() { /* ... V15と同じ ... */ }
        
        // --- 初期化処理 ---
        function initialize() {
            loadCurrentWork();
            loadSlotNames();
            if (!localStorage.getItem(STORAGE_KEY_CURRENT)) { goToSetupPhase(); }
            else { goToSetupPhase(); } // V12から必ず編成画面開始
        }
        
        initialize();

    </script>
<script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
<script>
  kofiWidgetOverlay.draw('alt4l', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Support me',
    'floating-chat.donateButton.background-color': '#794bc4',
    'floating-chat.donateButton.text-color': '#fff'
  });
</script>
</body>
</html>